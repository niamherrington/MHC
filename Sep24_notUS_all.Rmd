---
title: "MHQ Sep 24 Non US cohort overview"
author: "Niamh Errington"
date: "`r format(Sys.time(), '%d %B %Y')`" 
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning=FALSE}
#load libraries & read in data
library(tidyverse)
library(readr)
library(readxl)
library(data.table)
library(kableExtra)
library(lubridate)
library(janitor)
library(RColorBrewer)
library(likert)
library(labelled)
library(ggstats)
library(tidyverse)
library(pheatmap)
library(polycor)
library(ggtext)
library(dunn.test)

source("OrderFactorsSep24_notUS.R")
source("UsefulFunctionUS.R")

Other_1st <- Other_1st %>% left_join(., QuestionKey, by = c("Question" = "Identifier"))

# Fill in missing values in Sheet based on the value in identifier
Other_1st <- Other_1st %>%
  mutate(Sheet = case_when(is.na(Sheet) & Question %in% c('cannabisSmoking', 'cannabisVaping', 'currentSmoking', 'currentVaping', 'everQuitSmoking', 'pastSmokeless', 'pastVaping', 'tobaccoProducts', 'tobaccoProductsEver', 'everQuitSmokeless', 'everQuitVaping', 'lastCannabisSmoking', 'pastCannabisSmoking', 'lastCannabisVaping', 'pastCannabisVaping') ~ "Vaping_Smoking",   
    is.na(Sheet) & Question %in% c('NonIdentifiableDemographics.patientHeightInches', 'regionInformation.countryCode', 'NonIdentifiableDemographics.patientBloodType' ) ~ "DEMOGRAPHICS",   
     is.na(Sheet) & Question %in% c( 'heartAgeDataBloodGlucose_unit', 'heartAgeDataDiastolicBloodPressure', 'heartAgeDataDiastolicBloodPressure_unit', 'heartAgeDataHdl_unit', 'heartAgeDataSystolicBloodPressure_unit', 'heartAgeDataTotalCholesterol_unit') ~ "APH HEART AGE SURVEY",   
    TRUE ~ Sheet                           # Keep original value if no conditions match
  ))
```

# Illness Mindset

## First response, comparison 1

```{r}
kable(FreqWPerc(Other_1stWide, body_self_healing_in_many_different_circumstances, Comparison1), caption = "Your body can heal itself on its own in many different circumstances.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, chronic_illness_impact, Comparison1), caption = "Chronic illness negatively impacts nearly all parts of life.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, chronic_illness_body_meaning, Comparison1), caption = "Having a chronic illness means that your body isnâ€™t doing its job.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, chronic_illness_body_coping, Comparison1), caption = "Your body is able to cope with a chronic illness.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, chronic_illness_positive_opportunity, Comparison1), caption = "A chronic illness can be an opportunity to make positive life changes.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, chronic_illness_management, Comparison1), caption = "A chronic illness is manageable.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, chronic_illness_body_betrayal, Comparison1), caption = "If you have a chronic illness, it means your body has betrayed you.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, chronic_illness_more_meaning_in_life, Comparison1), caption = "Having a chronic illness allows you to find more meaning in life.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, chronic_illness_handling, Comparison1), caption = "A chronic illness is something that can be dealt with.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, body_remarkable_self_healing, Comparison1), caption = "In general, your body has remarkable self-healing properties.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, chronic_illness_spoil, Comparison1), caption = "Having a chronic illness spoils many parts of life.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, chronic_illness_challenge, Comparison1), caption = "Having a chronic illness is a challenge that can make you stronger.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, chronic_illness_body_handling, Comparison1), caption = "In general, your body is able to handle a chronic illness.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, chronic_illness_runing_life, Comparison1), caption = "A chronic illness ruins most aspects of life.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, chronic_illness_body_management, Comparison1), caption = "Your body is designed to deal with and manage chronic illnesses.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, chronic_illness_relatively_normal_life, Comparison1), caption = "You can live a relatively normal life with a chronic illness.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, chronic_illness_body_failure, Comparison1), caption = "Having a chronic illness means that your body has failed.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, chronic_illness_empowering, Comparison1), caption = "Fighting a chronic illness can be empowering.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, body_self_healing_from_most_conditions_and_diseases, Comparison1), caption = "Your body is able to heal itself from most conditions and diseases.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, chronic_illness_body_blame, Comparison1), caption = "Your body is to blame if you have a chronic illness.") %>% kable_styling(full_width = TRUE)
```


```{r}
selectedillness <- Other_1stWide %>% dplyr::select(all_of(variable_list_illnessmindset$Identifier), Comparison1)  %>% filter(!is.na(Comparison1))

colnames(selectedillness) <- c(variable_list_illnessmindset$Prompt, "Group")
```

```{r}
#svg, 1200x630
selectedillness%>% gglikert(., `Your body can heal itself on its own in many different circumstances.`:`Your body is to blame if you have a chronic illness.`, sort = "ascending", facet_cols = vars(Group), add_labels = FALSE) 

selectedillness%>% gglikert(., `Your body can heal itself on its own in many different circumstances.`:`Your body is to blame if you have a chronic illness.`, facet_cols = vars(Group), add_labels = FALSE) + geom_vline(xintercept = 0)

selectedillness %>%  gglikert(c(`Your body is able to heal itself from most conditions and diseases.`, `Having a chronic illness allows you to find more meaning in life.`), facet_cols = vars(Group), add_labels = FALSE) + geom_vline(xintercept = 0)

```

## Kruskal Wallis test 

```{r}
# Perform Kruskal wallis test for each variable
KW_pvals_IllnessMindset <- lapply(variable_list_illnessmindset$Identifier, function(var) {
  formula <- as.formula(paste(var, "~ Comparison1"))
  KS_result <- kruskal.test(formula, data = Other_1st_num) 
  p_value <- KS_result$p.value
  return(p_value)
})

# Create a table of p-values
KW_pvals_IllnessMindset <- data.frame(variable = variable_list_illnessmindset$Identifier, Prompt = variable_list_illnessmindset$Prompt, p_value = unlist(KW_pvals_IllnessMindset)) %>% dplyr::arrange(p_value) %>% mutate(p_adj = p.adjust(p_value, method = "BH")) 

kable(KW_pvals_IllnessMindset, caption = "Kruskal test p values for Illness Mindset questions. Simulated pvals = T") %>% kable_styling(full_width = TRUE)
```
## Post hoc Dunn test

```{r}
dunn.test(Other_1st_num$chronic_illness_more_meaning_in_life, Other_1st_num$Comparison1, method = "BH")

dunn.test(Other_1st_num$body_self_healing_from_most_conditions_and_diseases, Other_1st_num$Comparison1, method = "BH")

dunn.test(Other_1st_num$chronic_illness_body_meaning, Other_1st_num$Comparison1, method = "BH")

dunn.test(Other_1st_num$body_remarkable_self_healing, Other_1st_num$Comparison1, method = "BH")

dunn.test(Other_1st_num$chronic_illness_impact, Other_1st_num$Comparison1, method = "BH")

dunn.test(Other_1st_num$body_self_healing_in_many_different_circumstances, Other_1st_num$Comparison1, method = "BH")

```

# Exercise process mindset

## First response, comparison 1

```{r}
kable(FreqWPerc(Other_1stWide, easy, Comparison1), caption = "Exercising is: easy") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, pleasurable, Comparison1), caption = "Exercising is: pleasurable") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, relaxing, Comparison1), caption = "Exercising is: relaxing") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, convenient, Comparison1), caption = "Exercising is: convenient") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, fun, Comparison1), caption = "Exercising is: fun") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, social, Comparison1), caption = "Exercising is: social") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, indulgent, Comparison1), caption = "Exercising is: indulgent") %>% kable_styling(full_width = TRUE)

```

## Kruskal Test

```{r}
# List of variables for which Fisher's exact test will be performed
variable_list_exproc <- QuestionKey[QuestionKey$Sheet == "Exercise_process_mindset_measur",2:4]

# Perform Kruskal wallis test for each variable
KW_pvals_Expro <- lapply(variable_list_exproc$Identifier, function(var) {
  formula <- as.formula(paste(var, "~ Comparison1"))
  KW_result <- kruskal.test(formula, data = Other_1st_num) 
  p_value <- KW_result$p.value
  return(p_value)
})

# Create a table of p-values
KW_pvals_Expro <- data.frame(variable = variable_list_exproc$Identifier, Prompt = variable_list_exproc$Prompt, p_value = unlist(KW_pvals_Expro)) %>% dplyr::arrange(p_value) %>% mutate(p_adj = p.adjust(p_value, method = "BH")) 

kable(KW_pvals_Expro, caption = "Kruskal test p values for Exercise process mindset questions. Simulated pvals = T") %>% kable_styling(full_width = TRUE)


#
ezy <- MHQ %>% filter(Question == 'easy') %>% filter(!is.na(Question))
```

### Post hoc Dunn test

```{r}
dunn.test(Other_1st_num$relaxing, Other_1st_num$Comparison1, method = "BH")

dunn.test(Other_1st_num$social, Other_1st_num$Comparison1, method = "BH")

dunn.test(Other_1st_num$fun, Other_1st_num$Comparison1, method = "BH")
```


## Figures


```{r}
#1000 x 150 svg
Other_1stWide %>% dplyr::select(easy, Comparison1)   %>% dplyr::rename("Exercising is easy" = easy) %>% gglikert(., `Exercising is easy`, sort = "ascending", facet_cols = vars(Comparison1), add_labels = FALSE) 

Other_1stWide %>% dplyr::select(relaxing, Comparison1)  %>% dplyr::rename("Exercising is relaxing" = relaxing) %>% gglikert(., `Exercising is relaxing`, sort = "ascending", facet_cols = vars(Comparison1), add_labels = FALSE) 

Other_1stWide %>% dplyr::select(social, Comparison1)  %>% dplyr::rename("Exercising is social" = social) %>% gglikert(., `Exercising is social`, sort = "ascending", facet_cols = vars(Comparison1), add_labels = FALSE) 

Other_1stWide %>% dplyr::select(indulgent, Comparison1)  %>% dplyr::rename("Exercising is indulgent" = indulgent) %>% gglikert(., `Exercising is indulgent`, sort = "ascending", facet_cols = vars(Comparison1), add_labels = FALSE) 

Other_1stWide %>% dplyr::select(pleasurable, Comparison1)  %>% dplyr::rename("Exercising is pleasurable" = pleasurable) %>% gglikert(., `Exercising is pleasurable`, sort = "ascending", facet_cols = vars(Comparison1), add_labels = FALSE) 

Other_1stWide %>% dplyr::select(convenient, Comparison1)  %>% dplyr::rename("Exercising is convenient" = convenient) %>% gglikert(., `Exercising is convenient`, sort = "ascending", facet_cols = vars(Comparison1), add_labels = FALSE) 

Other_1stWide %>% dplyr::select(fun, Comparison1)  %>% dplyr::rename("Exercising is fun" = fun) %>% gglikert(., `Exercising is fun`, sort = "ascending", facet_cols = vars(Comparison1), add_labels = FALSE) 
```

```{r}
exercise_all <- Other_1stWide %>% dplyr::select(MHC_ID, variable_list_exproc$Identifier, Comparison1) %>% mutate(easy = dplyr::recode(easy, "Very difficult" = "Strongly disagree", "Somewhat difficult" = "Disagree", "Somewhat easy" = "Agree", "Very easy" = "Strongly agree"),                                                                                                   pleasurable = dplyr::recode(pleasurable, "Very unpleasant" = "Strongly disagree", "Somewhat unpleasant" = "Disagree", "Somewhat pleasurable" = "Agree", "Very pleasurable" = "Strongly agree"),                                                                                               relaxing = dplyr::recode(relaxing, "Very stressful" = "Strongly disagree", "Somewhat stressful" = "Disagree", "Somewhat relaxing" = "Agree", "Very relaxing" = "Strongly agree"),
                   convenient = dplyr::recode(convenient, "Very inconvenient" = "Strongly disagree", "Somewhat inconvenient" = "Disagree", "Somewhat convenient" = "Agree", "Very convenient" = "Strongly agree"),
                  fun = dplyr::recode(fun, "Very boring" = "Strongly disagree", "Somewhat boring" = "Disagree", "Somewhat fun" = "Agree", "Very fun" = "Strongly agree"),
                  social = dplyr::recode(social, "Very lonely" = "Strongly disagree", "Somewhat lonely" = "Disagree", "Somewhat social" = "Agree", "Very social" = "Strongly agree"),
                  indulgent = dplyr::recode(indulgent, "Very depriving" = "Strongly disagree", "Somewhat depriving" = "Disagree", "Somewhat indulgent" = "Agree", "Very indulgent" = "Strongly agree") ) %>% filter(!is.na(Comparison1))

exercise_all%>% gglikert(., `easy`:`indulgent`, facet_cols = vars(Comparison1), add_labels = FALSE) + geom_vline(xintercept = 0)

exercise_all <- exercise_all %>%  
  dplyr::rename("Exercising is easy" = easy) %>%
  dplyr::rename("Exercising is relaxing" = relaxing) %>%
  dplyr::rename("Exercising is social" = social) %>%
  dplyr::rename("Exercising is indulgent" = indulgent) %>%
  dplyr::rename("Exercising is pleasurable" = pleasurable) %>%
  dplyr::rename("Exercising is convenient" = convenient) %>%
  dplyr::rename("Exercising is fun" = fun)

exercise_all%>% gglikert(., `Exercising is easy`:`Exercising is indulgent`, facet_cols = vars(Comparison1), add_labels = FALSE) + geom_vline(xintercept = 0)

```


# Adequacy of activity mindset 

## First response, comparison 1

```{r}
kable(FreqWPerc(Other_1stWide, unhealthy, Comparison1), caption = "My current level of physical activity is unhealthy.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, weight, Comparison1), caption = "My current level of physical activity is helping me achieve or maintain a healthy body weight.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, beneficial, Comparison1), caption = "How harmful/beneficial is your current level of physical activity for your health?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, disease, Comparison1), caption = "How much does your current level of physical (in-)activity increase or decrease your risk of disease?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, muscles, Comparison1), caption = "How much is your current level of physical (in-)activity strengthening or weakening your muscles?") %>% kable_styling(full_width = TRUE)
```


## Kruskal Test

```{r}
# List of variables for which test will be performed
variable_list_activity <- QuestionKey[QuestionKey$Sheet == "Adequacy_of_activity_mindset_me",]

# Perform Kruskal wallis test for each variable
KW_pvals_Act <- lapply(variable_list_activity$Identifier, function(var) {
  formula <- as.formula(paste(var, "~ Comparison1"))
  KW_result <- kruskal.test(formula, data = Other_1st_num) 
  p_value <- KW_result$p.value
  return(p_value)
})

# Create a table of p-values
KW_pvals_Act <- data.frame(variable = variable_list_activity$Identifier, Prompt = variable_list_activity$Prompt, p_value = unlist(KW_pvals_Act)) %>% dplyr::arrange(p_value) %>% mutate(p_adj = p.adjust(p_value, method = "BH")) %>% arrange(p_value)

kable(KW_pvals_Act, caption = "Kruskal test p values for Activity process mindset questions") %>% kable_styling(full_width = TRUE)
```

## Figures

```{r}
#1100 x 160 svg
Other_1stWide %>% dplyr::select(unhealthy, Comparison1)  %>% filter(!is.na(unhealthy)) %>% dplyr::rename("My current level of physical activity is unhealthy." = unhealthy) %>% gglikert(., `My current level of physical activity is unhealthy.`, facet_cols = vars(Comparison1), add_labels = FALSE) 

Other_1stWide %>% dplyr::select(disease, Comparison1) %>% filter(!is.na(disease))  %>% dplyr::rename("	How much does your current level of physical (in-)activity increase or decrease your risk of disease?" = disease) %>% gglikert(., `	How much does your current level of physical (in-)activity increase or decrease your risk of disease?`, facet_cols = vars(Comparison1), add_labels = FALSE) + geom_vline(xintercept = 0)

Other_1stWide %>% dplyr::select(weight, Comparison1) %>% filter(!is.na(weight))  %>% dplyr::rename("My current level of physical activity is helping me achieve or maintain a healthy body weight." = weight) %>% gglikert(., `My current level of physical activity is helping me achieve or maintain a healthy body weight.`, facet_cols = vars(Comparison1), add_labels = FALSE) + geom_vline(xintercept = 0)

Other_1stWide %>% dplyr::select(beneficial, Comparison1) %>% filter(!is.na(beneficial))  %>% dplyr::rename("How harmful/beneficial is your current level of physical activity for your health?" = beneficial) %>% gglikert(., `How harmful/beneficial is your current level of physical activity for your health?`, facet_cols = vars(Comparison1), add_labels = FALSE) + geom_vline(xintercept = 0)

Other_1stWide %>% dplyr::select(muscles, Comparison1) %>% filter(!is.na(muscles))  %>% dplyr::rename("How much is your current level of physical (in-)activity strengthening or weakening your muscles?" = muscles) %>% gglikert(., `How much is your current level of physical (in-)activity strengthening or weakening your muscles?`, facet_cols = vars(Comparison1), add_labels = FALSE)  + geom_vline(xintercept = 0)

Other_1stWide %>% dplyr::select(unhealthy, weight, Comparison1)  %>% filter(!is.na(unhealthy)) %>% dplyr::rename("My current level of physical activity is unhealthy." = unhealthy)  %>% dplyr::rename("My current level of physical activity is helping me achieve or maintain a healthy body weight." = weight) %>% gglikert(., `My current level of physical activity is unhealthy.`:`My current level of physical activity is helping me achieve or maintain a healthy body weight.`, facet_cols = vars(Comparison1), add_labels = FALSE) + geom_vline(xintercept = 0)
```


# ACTIVITY AND SLEEP SURVEY

## First response, comparison 1

```{r}
kable(FreqWPerc(Other_1stWide, work, Comparison1), caption = "Do you do regular work?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, atwork, Comparison1), caption = "Work Time Activity.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, phys_activity, Comparison1), caption = "Leisure Time Activity.") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, moderate_act, Comparison1), caption = "Overall, how many minutes of moderate activity do you get in a week?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, vigorous_act, Comparison1), caption = "Overall, how many minutes of vigorous activity do you get in a week?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, sleep_time1, Comparison1), caption = "How much sleep do you usually get at night on weekdays or workdays?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, sleep_time, Comparison1), caption = "How much sleep do think you need every night to be rested?  (in hours)") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, sleep_diagnosis1, Comparison1), caption = "Have you ever been told by a doctor or other health professional that you have a sleep disorder?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, sleep_diagnosis2, Comparison1), caption = "Which of the following sleep disorders apply to you? (select all that apply).") %>% kable_styling(full_width = TRUE)

```

```{r}
Other_1stWide %>% filter(!is.na(moderate_act)) %>% ggplot(aes(x = Comparison1, y = moderate_act, colour = Comparison1)) + geom_boxplot() + geom_jitter() + theme_minimal() +  scale_color_manual(values = c("deeppink", "cornflowerblue", "midnightblue")) + ylab("Weekly moderate activity (min)") + ggtitle("Self reported minutes of moderate activity")

Other_1stWide %>% filter(!is.na(vigorous_act)) %>% ggplot(aes(x = Comparison1, y = vigorous_act, colour = Comparison1)) + geom_boxplot() + geom_jitter() + theme_minimal() +  scale_color_manual(values = c("deeppink", "cornflowerblue", "midnightblue")) + ylab("Weekly vigorous activity (min)") + ggtitle("Self reported minutes of vigorous activity")

Other_1stWide %>% filter(!is.na(sleep_time)) %>% ggplot(aes(x = Comparison1, y = sleep_time, colour = Comparison1)) + geom_boxplot() + geom_jitter() + theme_minimal() + ylab("Required sleep (hours)") + ggtitle("How much sleep do think you need every night to be rested?") + scale_color_manual(values = c("deeppink", "cornflowerblue", "midnightblue")) + theme(legend.title = element_blank())

Other_1stWide %>% filter(!is.na(sleep_time1)) %>% ggplot(aes(x = Comparison1, y = sleep_time1, colour = Comparison1)) + geom_boxplot() + geom_jitter() + theme_minimal()  + ylab("Self reported weeknight sleep") + ggtitle("How much sleep do you usually get at night on weekdays or workdays?")+ scale_color_manual(values = c("deeppink", "cornflowerblue", "midnightblue"))+ theme(legend.title = element_blank())
```

## Statistical tests

```{r}
fish_work<- fisher.test(Other_1stWide$work, Other_1stWide$Comparison1) 

kw_atwork <- kruskal.test(atwork ~ Comparison1, data = Other_1st_num)
kw_physact <- kruskal.test(phys_activity ~ Comparison1, data = Other_1st_num)
kw_modact <- kruskal.test(moderate_act ~ Comparison1, data = Other_1stWide)
kw_vigact<- kruskal.test(vigorous_act ~ Comparison1, data = Other_1stWide)

kw_sleep <- kruskal.test(sleep_time ~ Comparison1, data = Other_1stWide)
kw_sleep1 <- kruskal.test(sleep_time1 ~ Comparison1, data = Other_1stWide)

actsleep_pvals <- rbind(c("work", "Do you do regular work?", fish_work$p.value),
                         c("atwork", "Physicality of work time activity", kw_atwork$p.value),
                         c("phys_activity", "Physicality of work time activity", kw_physact$p.value),
                         c("moderate_act", "Overall, how many minutes of moderate activity do you get in a week?", kw_modact$p.value[1]),
                         c("vigorous_act", "Overall, how many minutes of vigorous activity do you get in a week?", kw_vigact$p.value[1]),
                         c("sleep_time", "How much sleep do think you need every night to be rested? (in hours)", kw_sleep$p.value[1]),
                         c("sleep_time1", "How much sleep do you usually get at night on weekdays or workdays?", kw_sleep1$p.value[1]) )
colnames(actsleep_pvals) <- c("variable", "Prompt", "p_value")

actsleep_pvals <- as.data.frame(actsleep_pvals)

kable(actsleep_pvals) %>% kable_styling(full_width = TRUE)

```

```{r}
dunn.test(Other_1st_num$vigorous_act, Other_1st_num$Comparison1, method = "BH")
```

### Post hoc Dunn test

```{r}
dunn.test(Other_1st_num$relaxing, Other_1st_num$vigorous_act, method = "BH")
```

# Risk Factor Survey

## First response, comparison 1

```{r}
kable(FreqWPerc(Other_1stWide, family_history, Comparison1), caption = "Do you have a family history of early heart disease?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, medications_to_treat, Comparison1), caption = "Do you take medications to treat the following risk factors (indicate all that apply)") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, heart_disease, Comparison1), caption = "Have you been diagnosed with any of the below diseases?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, vascular, Comparison1), caption = "Which vascular disease diagnosis have you received?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, ethnicity, Comparison1), caption = "Are you Spanish/Hispanic/Lation? Choose the best answer. ") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, race, Comparison1), caption = "What is your race? Choose one or more races to indicate what you consider yourself to be. ") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, education, Comparison1), caption = "What is the highest grade in school you finished? Choose the best answer. NB 1st answer only, NOT highest achieved") %>% kable_styling(full_width = TRUE)
```

# Satisfaction Survey

## First response, comparison 1

```{r}
kable(FreqWPerc(Other_1stWide, satisfiedwith_life, Comparison1), caption = "Overall, how satisfied are you with life as a whole these days?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, feel_worthwhile1, Comparison1), caption = "Overall, to what extent do you feel the things you do in your life are worthwhile?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, feel_worthwhile2, Comparison1), caption = "How about happy?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, feel_worthwhile3, Comparison1), caption = "How about worried?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, feel_worthwhile4, Comparison1), caption = "How about depressed?") %>% kable_styling(full_width = TRUE)
```

```{r}
kw_sat <- kruskal.test(satisfiedwith_life ~ Comparison1, data = Other_1stWide)
kw_fw1 <- kruskal.test(feel_worthwhile1 ~ Comparison1, data = Other_1stWide)
kw_fw2 <- kruskal.test(feel_worthwhile2 ~ Comparison1, data = Other_1stWide)
kw_fw3 <- kruskal.test(feel_worthwhile3 ~ Comparison1, data = Other_1stWide)
kw_fw4 <- kruskal.test(feel_worthwhile4 ~ Comparison1, data = Other_1stWide)

sat_pvals <- rbind(c("satisfiedwith_life", "Overall, how satisfied are you with life as a whole these days?", kw_sat$p.value[1]),
                   c("feel_worthwhile1", "Overall, to what extent do you feel the things you do in your life are worthwhile?", kw_fw1$p.value[1]),
                   c("feel_worthwhile2", "How about happy?", kw_fw2$p.value[1]),
                   c("feel_worthwhile3", "How about worried?", kw_fw3$p.value[1]),
                   c("feel_worthwhile4", "How about depressed?", kw_fw4$p.value[1]))

colnames(sat_pvals) <- c("variable", "Prompt", "p_value")

sat_pvals <- as.data.frame(sat_pvals)

kable(sat_pvals) %>% kable_styling(full_width = TRUE)

```

```{r}
kable(FreqWPerc(Other_1stWide, riskfactors1, Comparison1), caption = "Over the next 10 years how likely do you think it is that you personally will have a heart attack, stroke, or die due to cardiovascular disease? (choose one)") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, riskfactors2, Comparison1), caption = "Over the next 10 years, compared to others your age and sex, how would you rate your risk of having a heart attack, stroke, or dying due to cardiovascular disease? (choose one)") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, riskfactors3, Comparison1), caption = "Over your lifetime how likely do you think it is that you personally will have a heart attack, stroke, or die due to cardiovascular disease? (choose one)") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, riskfactors4, Comparison1), caption = "Over your lifetime, compared to others your age and sex, how would you rate your risk of having a heart attack, stroke, or dying due to cardiovascular disease? (choose one)") %>% kable_styling(full_width = TRUE)
```


## Kruskal Wallis Test

```{r}
# List of variables for which Fisher's exact test will be performed
variable_list_RF <- QuestionKey %>% filter(Identifier %in% c("riskfactors1", "riskfactors2", "riskfactors3", "riskfactors4")) %>% dplyr::select(-Sheet)

# Perform Kruskal wallis test for each variable
KW_pvals_RF <- lapply(variable_list_RF$Identifier, function(var) {
  formula <- as.formula(paste(var, "~ Comparison1"))
  KW_result <- kruskal.test(formula, data = Other_1st_num) 
  p_value <- KW_result$p.value
  return(p_value)
})

# Create a table of p-values
KW_pvals_RF <- data.frame(variable = variable_list_RF$Identifier, Prompt = variable_list_RF$Prompt, p_value = unlist(KW_pvals_RF)) %>% dplyr::arrange(p_value) %>% mutate(p_adj = p.adjust(p_value, method = "BH")) 

kable(KW_pvals_RF, caption = "Kruskal test p values for satisfaction survey risk factors") %>% kable_styling(full_width = TRUE)

```

```{r}
dunn.test(Other_1st_num$riskfactors1, Other_1st_num$Comparison1, method = "BH")
dunn.test(Other_1st_num$riskfactors2, Other_1st_num$Comparison1, method = "BH")
dunn.test(Other_1st_num$riskfactors3, Other_1st_num$Comparison1, method = "BH")
dunn.test(Other_1st_num$riskfactors4, Other_1st_num$Comparison1, method = "BH")

```


# Par-Q Quiz

## First response, comparison 1

```{r}
hc <- FreqWPerc(Other_1stWide, heartCondition, Comparison1) %>% as.data.frame()
cp <-  FreqWPerc(Other_1stWide, chestPain, Comparison1) %>% as.data.frame()
cpim <- FreqWPerc(Other_1stWide, chestPainInLastMonth, Comparison1) %>% as.data.frame()
d <- FreqWPerc(Other_1stWide, dizziness, Comparison1) %>% as.data.frame()
jp <- FreqWPerc(Other_1stWide, jointProblem, Comparison1) %>% as.data.frame()
pc <- FreqWPerc(Other_1stWide, physicallyCapable, Comparison1) %>% as.data.frame()
pd <- FreqWPerc(Other_1stWide, prescriptionDrugs, Comparison1) %>% as.data.frame()

kable(hc, caption = "has your doctor ever said that you have a heart condition and that you should only do physical activity recommended by a doctor? ") %>% kable_styling(full_width = TRUE)

kable(cp, caption = "Do you feel pain in your chest when you do physical activity?") %>% kable_styling(full_width = TRUE)

kable(cpim, caption = "In the past month, have you had chest pain when you were not doing physical activity? ") %>% kable_styling(full_width = TRUE)

kable(d, caption = "Do you lose your balanced because of dizziness or do you ever lose consciousness? ") %>% kable_styling(full_width = TRUE)

kable(jp, caption = "Do you have a bone or joint problem that could be made worse by a change in your physical activity? ") %>% kable_styling(full_width = TRUE)

kable(pc, caption = "Do you know of any reason why you should not do physical activity? ") %>% kable_styling(full_width = TRUE)

kable(pd, caption = "Is your doctor currently prescribing drugs (for example water pills) for your blood pressure or heart condition? ") %>% kable_styling(full_width = TRUE)

```

```{r}
hc1 <- hc %>% pivot_longer(cols = !Comparison1) %>% mutate(q = "Has your doctor ever said that you have a heart condition \n and that you should only do physical activity recommended by a doctor?")
cp1 <- cp %>% pivot_longer(cols = !Comparison1) %>% mutate(q = "Do you feel pain in your chest when you do physical activity?")
cpim1 <- cpim %>% pivot_longer(cols = !Comparison1) %>% mutate(q = "In the past month, have you had chest pain when you were not doing physical activity?")
d1 <- d %>% pivot_longer(cols = !Comparison1) %>% mutate(q = "Do you lose your balanced because of dizziness or do you ever lose consciousness?")
jp1 <- jp %>% pivot_longer(cols = !Comparison1) %>% mutate(q = "Do you have a bone or joint problem that could be made worse by a change in your physical activity?")
pc1 <- pc %>% pivot_longer(cols = !Comparison1) %>% mutate(q = "Do you know of any reason why you should not do physical activity?")
pd1 <- pd %>% pivot_longer(cols = !Comparison1) %>% mutate(q = "Is your doctor currently prescribing drugs (for example water pills) for your blood pressure or heart condition?")

a <- rbind(hc1, cp1, cpim1, d1, jp1, pc1, pd1) 
a[c("value", "n")] <- str_split_fixed(a$value, '%', 2)
a <- a %>% mutate(value = as.numeric(value)) 

ggplot(data =a, aes(x = Comparison1, y = value, group = name, fill = name)) + geom_col() + facet_wrap(~q, ncol = 1) + scale_fill_manual(values = c("deeppink", "midnightblue")) + labs(x = "", y = "% answer")
```


## Fisher Test

```{r}
# List of variables for which Fisher's exact test will be performed
variable_list_parq <- QuestionKey[QuestionKey$Sheet == "PAR-Q QUIZ", ]

# Perform Fisher's exact test for each variable
Fisher_pvals_parq <- lapply(variable_list_parq$Identifier, function(var) {
  contingency_table <- table(Other_1stWide[[var]], Other_1stWide$Comparison1)
  fisher_result <- fisher.test(contingency_table, simulate.p.value=TRUE)
  p_value <- fisher_result$p.value
  return(p_value)
})

# Create a table of p-values
Fisher_pvals_parq_tab <- data.frame(variable = variable_list_parq$Identifier, Prompt = variable_list_parq$Prompt, p_value = unlist(Fisher_pvals_parq)) %>% arrange(p_value) %>% mutate(p_adj = p.adjust(p_value, method = "BH")) 

kable(Fisher_pvals_parq_tab, caption = "Fisher exact test p values for Par-Q Quiz. Simulated pvals = T") %>% kable_styling(full_width = TRUE)
```

# Diet

(None normally distributed)

```{r}
Dietvars <- QuestionKey[QuestionKey$Sheet == "CARDIO DIET SURVEY", 2:3]

kable(FreqWPerc(Other_1stWide, fruit, Comparison1), caption = "How many cups of fruit do you eat in an average day?") %>% kable_styling(full_width = TRUE)

Other_1stWide %>% group_by(Comparison1) %>% summarise(`mean fruit portions` = mean(fruit, na.rm = TRUE), `sd fruit portions` = sd(fruit, na.rm = TRUE), `median fruit portions` = median(fruit, na.rm = TRUE), `IQR fruit portions` = IQR(fruit, na.rm = TRUE) ) %>% kable(.) %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, vegetable, Comparison1), caption = "How many cups of vegetables do you eat in an average day?") %>% kable_styling(full_width = TRUE)

Other_1stWide %>% group_by(Comparison1) %>% summarise(`mean veg portions` = mean(vegetable, na.rm = TRUE), `sd veg portions` = sd(vegetable, na.rm = TRUE), `median veg portions` = median(vegetable, na.rm = TRUE), `IQR veg portions` = IQR(vegetable, na.rm = TRUE) ) %>% kable(.) %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, fish, Comparison1), caption = "How many servings of fish do you eat on an average week?") %>% kable_styling(full_width = TRUE)

Other_1stWide %>% group_by(Comparison1) %>% summarise(`mean fish portions` = mean(fish, na.rm = TRUE), `sd fish portions` = sd(fish, na.rm = TRUE), `median fish portions` = median(fish, na.rm = TRUE), `IQR fish portions` = IQR(fish, na.rm = TRUE) ) %>% kable(.) %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, grains, Comparison1), caption = "How many servings of whole grains do you eat on an average day?") %>% kable_styling(full_width = TRUE)

Other_1stWide %>% group_by(Comparison1) %>% summarise(`mean grains portions` = mean(grains, na.rm = TRUE), `sd grains portions` = sd(grains, na.rm = TRUE), `median grains portions` = median(grains, na.rm = TRUE), `IQR grains portions` = IQR(grains, na.rm = TRUE) ) %>% kable(.) %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, sugar_drinks, Comparison1), caption = "How many beverages with added sugar do you drink every week?") %>% kable_styling(full_width = TRUE)

Other_1stWide %>% group_by(Comparison1) %>% summarise(`mean sugar drinks` = mean(sugar_drinks, na.rm = TRUE), `sd sugar drinks` = sd(sugar_drinks, na.rm = TRUE), `median sugar drinks` = median(sugar_drinks, na.rm = TRUE), `IQR sugar drinks` = IQR(sugar_drinks, na.rm = TRUE) ) %>% kable(.) %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, sodium, Comparison1), caption = "Select the statements that apply to you:") %>% kable_styling(full_width = TRUE)

```

```{r}
# Fit the Poisson regression model
poisson_model_fruit <- glm(fruit ~ Comparison1, data = Other_1stWide, family = poisson)
poisson_model_vegetable <- glm(vegetable ~ Comparison1, data = Other_1stWide, family = poisson)
poisson_model_fish <- glm(fish ~ Comparison1, data = Other_1stWide, family = poisson)
poisson_model_grains <- glm(grains ~ Comparison1, data = Other_1stWide, family = poisson)
poisson_model_sugar_drinks <- glm(sugar_drinks ~ Comparison1, data = Other_1stWide, family = poisson)

# Summary of the model
summary(poisson_model_fruit)
summary(poisson_model_vegetable)
summary(poisson_model_fish)
summary(poisson_model_grains)
summary(poisson_model_sugar_drinks)

Other_1stWide %>% filter(sodium != "[]") %>% tabyl(sodium, Comparison1) %>% fisher.test()

```

## Kruskal-Wallis test

```{r}
kruskal_fruit <- kruskal.test(fruit ~ Comparison1, data = Other_1stWide)
kruskal_vegetable <- kruskal.test(vegetable ~ Comparison1, data = Other_1stWide)
kruskal_fish <- kruskal.test(fish ~ Comparison1, data = Other_1stWide)
kruskal_grains <- kruskal.test(grains ~ Comparison1, data = Other_1stWide)
kruskal_sugar_drinks <- kruskal.test(sugar_drinks ~ Comparison1, data = Other_1stWide)

diet_pvals <- rbind(c("fruit", "How many cups of fruit do you eat in an average day?", kruskal_fruit$p.value[1] ),
      c("vegetable", "How many cups of vegetables do you eat in an average day?", kruskal_vegetable$p.value[1] ),
      c("fish", "How many servings of fish do you eat on an average week?", kruskal_fish$p.value[1] ),
      c("grains", "How many servings of whole grains do you eat on an average day?", kruskal_grains$p.value[1] ),
      c("sugar_drinks", "How many beverages with added sugar do you drink every week?", kruskal_sugar_drinks$p.value[1] ))

colnames(diet_pvals) <- c("variable", "Prompt", "p_value")

diet_pvals <- as.data.frame(diet_pvals)
kable(diet_pvals) %>% kable_styling(full_width = TRUE)


```

```{r}
dunn.test(Other_1st_num$sugar_drinks, Other_1st_num$Comparison1, method = "BH")
dunn.test(Other_1st_num$fruit, Other_1st_num$Comparison1, method = "BH")
```

```{r}
food_portions <- Other_1stWide %>% dplyr::select(MHC_ID, Comparison1, fruit, vegetable, grains, fish, sugar_drinks) %>% pivot_longer(cols = !c("Comparison1", "MHC_ID"))

# Calculate mean values for each group within each facet
mean_data_food <- food_portions %>%
  group_by(name, Comparison1) %>%
  summarize(mean_value = mean(value, na.rm = TRUE), .groups = 'drop') %>% mutate(name = dplyr:::recode(name, "fruit" = "How many cups of fruit do you eat in an average day? (pval = 0.0031)", "vegetable" = "How many cups of vegetables do you eat in an average day? (pval = 0.0368)", "fish" = "How many servings of fish do you eat on an average week? (pval = 0.7728)", "grains" = "How many servings of whole grains do you eat on an average day? (pval = 0.1153)", "sugar_drinks" = "How many beverages with added sugar do you drink every week? (pval = 0.0007)") )

food_portions <- food_portions %>%  mutate(B = ifelse(name == "sugar_drinks", "B", "A")) %>% mutate(name = dplyr:::recode(name, "fruit" = "How many cups of fruit do you eat in an average day? (pval = 0.0031)", "vegetable" = "How many cups of vegetables do you eat in an average day? (pval = 0.0368)", "fish" = "How many servings of fish do you eat on an average week? (pval = 0.7728)", "grains" = "How many servings of whole grains do you eat on an average day? (pval = 0.1153)", "sugar_drinks" = "How many beverages with added sugar do you drink every week? (pval = 0.0007)") )

food_portions %>% ggplot(aes(x = value, y = Comparison1, fill = Comparison1)) + geom_col() + facet_wrap(~name, ncol = 1, scales = "free_x") + theme_minimal() + scale_fill_manual(values = c("deeppink", "cornflowerblue", "midnightblue")) + theme(legend.position="none") + labs(y = "")

mean_data_food %>% ggplot(aes(x = mean_value, y = Comparison1, fill = Comparison1)) + geom_col() + facet_wrap(~name, ncol = 1, scales = "free_x") + theme_minimal() + scale_fill_manual(values = c("deeppink", "cornflowerblue", "midnightblue")) + theme(legend.position="none") + labs(y = "")
```

# Smoking 

All smoking/vaping/smokeless

```{r}
kable(FreqWPerc(Other_1stWide, current_nicotine, Comparison1), caption = "Do you currently use smoke / vape / use smokeless products?") %>% kable_styling(full_width = TRUE)

smk<- FreqWPerc(Other_1stWide, current_nicotine, Comparison1) %>% as.data.frame() %>% pivot_longer(cols = c(`TRUE`, `FALSE`))
smk[c("value", "n")] <- str_split_fixed(smk$value, '%', 2)
smk <- smk %>% mutate(value = as.numeric(value))
smk %>% ggplot(aes(x = Comparison1, y = value, fill = name)) + geom_col() + scale_fill_manual(values = c("deeppink", "midnightblue")) + theme_minimal() + labs(x = "", y = "% answer") + theme(legend.title = element_blank()) + ggtitle("Current percentage of smokers / vapers (-pvalue 0.2394)")

fish_currentsmoke <- fisher.test(Other_1stWide$current_nicotine, Other_1stWide$Comparison1) 
fish_currentsmoke
```

## Vaping

```{r}
Smokevars <- QuestionKey[QuestionKey$Sheet == "Vaping_Smoking", 2:3]

kable(FreqWPerc(Other_1stWide, currentVaping, Comparison1), caption = "Do you currently vape nicotine") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, readinessQuitVaping, Comparison1), caption = "On a scale of 1-10, how ready do you feel to quit vaping") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, pastVaping, Comparison1), caption = "Have you vaped in the past?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, onsetVaping, Comparison1), caption = "How old were you when you first vaped (in years)? ") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, everQuitVaping, Comparison1), caption = "During the past 12 months, have you tried to stop vaping? ") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, durationQuitVaping, Comparison1), caption = "What is the longest period that you were able to quit vaping?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, methodQuitVaping, Comparison1), caption = "What strategy was MOST useful in quitting vaping?") %>% kable_styling(full_width = TRUE)
```

## Smoking

```{r}
Smokevars <- QuestionKey[QuestionKey$Sheet == "Vaping_Smoking", 2:3]

kable(FreqWPerc(Other_1stWide, currentSmoking, Comparison1), caption = "Do you currently smoke nicotine") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, readinessQuitSmoking, Comparison1), caption = "On a scale of 1-10, how ready do you feel to quit smoking") %>% kable_styling(full_width = TRUE)

#kable(FreqWPerc(Other_1stWide, pastSmoking, Comparison1), caption = "Have you vaped in the past?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, onsetSmoking, Comparison1), caption = "How old were you when you first smoked (in years)? ") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, everQuitSmoking, Comparison1), caption = "During the past 12 months, have you tried to stop smoking? ") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, durationQuitSmoking, Comparison1), caption = "What is the longest period that you were able to quit smoking?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, methodQuitSmoking, Comparison1), caption = "What strategy was MOST useful in quitting smoking?") %>% kable_styling(full_width = TRUE)
```
## Smokeless

```{r}
Smokevars <- QuestionKey[QuestionKey$Sheet == "Vaping_Smoking", 2:3]

kable(FreqWPerc(Other_1stWide, currentSmokeless, Comparison1), caption = "Do you currently use smokeless tobacco (chewing tobacco, snuff, snus, and dissolvable tobacco products)?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, readinessQuitSmokeless, Comparison1), caption = "On a scale of 1-10, how ready do you feel to quit smokeless tobacco?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, pastSmokeless, Comparison1), caption = "Have you vaped in the past?") %>% kable_styling(full_width = TRUE)

#kable(FreqWPerc(Other_1stWide, onsetSmokeless, Comparison1), caption = "How old were you when you first smoked (in years)? ") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, everQuitSmokeless, Comparison1), caption = "During the past 12 months, have you tried to stop chewing tobacco (chewing tobacco, snuff, snus, and dissolvable tobacco products)?)") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, durationQuitSmokeless, Comparison1), caption = "What is the longest period that you were able to chewing tobacco (chewing tobacco, snuff, snus, and dissolvable tobacco products)?") %>% kable_styling(full_width = TRUE)

kable(FreqWPerc(Other_1stWide, methodQuitSmokeless, Comparison1), caption = "What strategy was MOST useful in quitting smokeless tobacco?") %>% kable_styling(full_width = TRUE)
```


# P-values

```{r}
all_pvals <- do.call(rbind, list(dplyr::select(KW_pvals_IllnessMindset, variable, Prompt, p_value),
dplyr::select(KW_pvals_Expro, variable, Prompt, p_value),
dplyr::select(KW_pvals_Act, variable, Prompt, p_value),
dplyr::select(KW_pvals_RF, variable, Prompt, p_value),
dplyr::select(Fisher_pvals_parq_tab, variable, Prompt, p_value),
dplyr::select(sat_pvals, variable, Prompt, p_value),
dplyr::select(diet_pvals, variable, Prompt, p_value),
dplyr::select(actsleep_pvals, variable, Prompt, p_value), c("current_nicotine", "Do you currently smoke / use a vape/ use smokeless products?", fish_currentsmoke$p.value)  ))

all_pvals <- all_pvals %>% mutate(p_value = as.numeric(p_value)) %>% mutate(p_adj = p.adjust(p_value, method = "BH") ) %>% mutate(p_log10 = log10(p_value), p_log = log(p_value)) %>% arrange(p_adj, p_value)

kable(all_pvals) %>% kable_styling(full_width = TRUE)

```
# P values shortlist

```{r}
Juancosl <- c("patient","atwork","beneficial","body_remarkable_self_healing","body_self_healing_from_most_conditions_and_diseases","body_self_healing_in_many_different_circumstances","chestPain","chestPainInLastMonth","convenient","currentSmokeless","currentSmoking","currentVaping","disease","dizziness","easy","family_history","feel_worthwhile1","feel_worthwhile2","feel_worthwhile3","feel_worthwhile4","fun","indulgent","jointProblem","moderate_act","muscles","phys_activity","physicallyCapable","pleasurable","relaxing","satisfiedwith_life","sleep_diagnosis1","sleep_diagnosis2","sleep_time","sleep_time1","social","unhealthy","vigorous_act","weight","work","sugar_drinks","alcohol","fish","fruit","grains","vegetable","sodium", "race", "education")
              
all_pvals_shortlist <- all_pvals %>% filter(variable %in% Juancosl) %>% mutate(p_adj = p.adjust(p_value, method = "BH") ) %>% arrange(p_adj, p_value)
  
kable(all_pvals_shortlist) %>% kable_styling(full_width = TRUE)
            
```


# Polychoric Matrices


```{r}
x <- Other_1st_num[,variable_list_illnessmindset$Identifier]

x$MHC_ID <- Other_1st_num$MHC_ID
x$Comparison1 <- Other_1st_num$Comparison1

# Calculate the proportion of missing values for each row
missing_proportion <- rowMeans(is.na(x))

# Filter out rows with more than half of the values missing
x_clean <- x[missing_proportion <= 0.5, ]
xc<- as.matrix(x_clean[1:20])

x_PH <- x_clean %>% filter(Comparison1 == "PH")
x_PH <- as.matrix(x_PH[1:20])

x_healthy <- x_clean %>% filter(Comparison1 == "Healthy")
x_healthy <- as.matrix(x_healthy[1:20])

x_DC <- x_clean %>% filter(Comparison1 == "DC")
x_DC <- as.matrix(x_DC[1:20])


em <- Other_1st_num[, variable_list_exproc$Identifier]
em$MHC_ID <- Other_1st_num$MHC_ID
em$Comparison1 <- Other_1st_num$Comparison1

# Calculate the proportion of missing values for each row
missing_proportion <- rowMeans(is.na(em))

# Filter out rows with more than half of the values missing
em_clean <- em[missing_proportion <= 0.5, ]
emc<- as.matrix(em_clean[-c(8:9)])

emc_PH <- em_clean %>% filter(Comparison1 == "PH")
emc_PH <- as.matrix(emc_PH[-c(8:9)])

emc_healthy <- em_clean %>% filter(Comparison1 == "Healthy")
emc_healthy <- as.matrix(emc_healthy[-c(8:9)])

emc_DC <- em_clean %>% filter(Comparison1 == "DC")
emc_DC <- as.matrix(emc_DC[-c(8:9)])


am <- Other_1st_num[, variable_list_activity$Identifier ]
am$MHC_ID <- Other_1st_num$MHC_ID
am$Comparison1 <- Other_1st_num$Comparison1

# Calculate the proportion of missing values for each row
missing_proportion <- rowMeans(is.na(am))

# Filter out rows with more than half of the values missing
am_clean <- am[missing_proportion <= 0.5, ]
amc<- as.matrix(am_clean[-c(6:7)])

amc_PH <- am_clean %>% filter(Comparison1 == "PH")
amc_PH <- as.matrix(amc_PH[-c(6:7)])

amc_healthy <- am_clean %>% filter(Comparison1 == "Healthy")
amc_healthy <- as.matrix(amc_healthy[-c(6:7)])

amc_DC <- am_clean %>% filter(Comparison1 == "DC")
amc_DC <- as.matrix(amc_DC[-c(6:7)])
```

```{r}
polychor_heatmap  <- function(data, title) {
  # Calculate the polychoric correlation matrix
  polychoric_cor <- hetcor(data, ML = TRUE)
  
  # Extract the correlation matrix
  polychoric_matrix <- polychoric_cor$correlations
  
  # Melt the correlation matrix 
  polychoric_melted <- reshape2::melt(polychoric_matrix)
  
  # Set breaks to ensure the color scale runs from -1 to 1
  breaks <- seq(-1, 1, length.out = 51)
  
  # Create the heatmap with pheatmap
  pheatmap(polychoric_matrix,
           cluster_rows = FALSE,   # Disable row clustering
           cluster_cols = FALSE,   # Disable column clustering
           display_numbers = TRUE,
           color = colorRampPalette(c("blue", "white", "red"))(50),
           breaks = breaks,
           main = title)
}

#1100 x 750 svg
polychor_heatmap(xc, "Polychoric correlation matrix for illness mindset")
```

```{r}
#618x454
polychor_heatmap(emc, "Polychoric correlation matrix for exercise process mindset")
```


```{r}
#618x454
polychor_heatmap(amc, "Polychoric correlation matrix for activity process mindset")
```

# Polychoric matrix by disease group

```{r}
#1100x750
polychor_heatmap(x_PH, "Polychoric correlation matrix for illness mindset: PH")
polychor_heatmap(x_healthy, "Polychoric correlation matrix for illness mindset: Healthy")
polychor_heatmap(x_DC, "Polychoric correlation matrix for illness mindset: DC")

#618x454
polychor_heatmap(emc_PH, "Polychoric correlation matrix for exercise process mindset: PH")
polychor_heatmap(emc_healthy, "Polychoric correlation matrix for exercise process mindset: Healthy")
polychor_heatmap(emc_DC, "Polychoric correlation matrix for exercise process mindset: DC")

#618x454
polychor_heatmap(amc_PH, "Polychoric correlation matrix for activity process mindset: PH")
polychor_heatmap(amc_healthy, "Polychoric correlation matrix for activity process mindset: Healthy")
polychor_heatmap(amc_DC, "Polychoric correlation matrix for activity process mindset: DC")
```



